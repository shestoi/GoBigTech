# Notification Service и Telegram-уведомления

## Когда отправляются уведомления

Notification Service отправляет сообщения **только если у пользователя в IAM задан `telegram_id`**.

- **telegram_id** в нашем проекте — это **Telegram chat_id**, который используется в Telegram Bot API методом `sendMessage` (параметр `chat_id`). Обычно это числовой ID чата с ботом или строковое представление (например, `"123456789"`).
- Если `telegram_id` у пользователя **отсутствует или пустой** — уведомление **не отправляется**, событие помечается как **sent** (обработанное), чтобы не ретраить его. Это **ожидаемое продовое поведение**: пользователи без Telegram просто не получают push-уведомления.

## Поведение при отсутствии telegram_id

| Ситуация | Действие Notification | Результат |
|----------|------------------------|-----------|
| Пользователь не найден в IAM (NotFound) | Событие помечается sent, уведомление не отправляется | Retry не выполняется |
| У пользователя пустой/отсутствует telegram_id | Событие помечается sent, уведомление не отправляется | Retry не выполняется |
| telegram_id задан | Запрос в IAM, отправка в Telegram | При ошибке API — retry по inbox |

**Важно:** Не делать `telegram_id` обязательным при регистрации в IAM. Если `telegram_id` не указан — уведомления не отправляются; это документированное поведение.

## Как тестировать уведомления

1. **Зарегистрировать пользователя с telegram_id** через IAM:
   ```bash
   grpcurl -plaintext -d '{
     "login": "testuser",
     "password": "testpass123",
     "telegram_id": "YOUR_CHAT_ID"
   }' 127.0.0.1:50053 iam.v1.IAMService/Register
   ```
2. **Убедиться, что chat_id валиден** и бот имеет доступ к чату: пользователь должен был начать диалог с ботом (Start) или добавить бота в группу. Иначе Telegram API вернёт ошибку (например, "chat not found").
3. Создать заказ от этого пользователя (Order → Payment → Assembly), чтобы по цепочке событий Notification получил событие и отправил сообщение в Telegram.

Переменная окружения Notification: `TELEGRAM_BOT_TOKEN` — токен бота от [@BotFather](https://t.me/BotFather).

## Истёкшая сессия (TTL)

Для защищённых вызовов (Order, Inventory и т.д.) клиент обязан передавать **x-session-id**. Если TTL сессии истёк — нужно снова выполнить **Login** в IAM и использовать новый `session_id`. Подробнее: [IAM_SESSIONS.md](IAM_SESSIONS.md).
